var app,charting,chartUtils,UNITS,d3,cell;app={_buffer:null,_point:null,_distance:null,_distanceUnits:null,_alertBox:null,_carsl:null,_chartsDone:0,init:function(){require(["esri/config","esri/tasks/GeometryService"],function(_1,_2){_1.defaults.io.proxyUrl=config.proxy;});app._carsl=$("#myCarousel div.carousel-inner");app._distance=config.distance;app._distanceUnits=config.units;app._alertBox=$("<div id=\"alertBox\"></div>").appendTo("#splashscreen .modal-body");$(".modal-footer").removeClass("fade");},test:function(){require(["esri/geometry/Point"],function(_3){app._point=new _3(-74,40.73);app.buildCharts();});},geolocate:function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(app.onGeoSuccess,app.onGeoError);}else{app.test();}},onGeoSuccess:function(_4){require(["esri/geometry/Point"],function(_5){app._point=new _5(_4.coords.longitude,_4.coords.latitude);app.buildCharts();});},onGeoError:function(_6){$("<div></div>").addClass("alert").addClass("alert-error").html("Error: Could not get coordinates; using NYC").appendTo(app._alertBox);app.test();},buildCharts:function(){app.logResult("Loading map data");app.createMap(app._carsl);app.bufferPoint(app._point,app._distance,UNITS[app._distanceUnits]);},bufferPoint:function(_7,_8,_9){require(["esri/tasks/GeometryService","esri/tasks/BufferParameters"],function(_a,_b){var _c,_d;_c=new _b();_c.geometries=[_7];_c.distances=[_8];_c.geodesic=true;_c.unit=_9;_d=new _a(config.geometryURL);_d.buffer(_c,app.onBuffer);});},onBuffer:function(_e){app._buffer=_e[0];if(app.map.graphics){app.placeGraphics();}else{require(["dojo/on"],function(on){on.once(app.map,"load",app.placeGraphics);});}app.logResult("Loading Census data");require(["esri/tasks/query","esri/tasks/QueryTask"],function(_f,_10){var q,qt;q=new _f();q.geometry=app._buffer;q.outFields=config.blockGroup.fields;qt=new _10(config.blockGroup.url);qt.execute(q,app.onQuery);});},onQuery:function(_11){var _12=app.createGeoTree(_11.features);$.each(config.charts,function(_13,_14){var _15,_16;_16=_13+1;_15="itemContent"+_16;$(app.itemTemplate(_14,_16)).appendTo(app._carsl).height($("#myCarousel").height());$("#"+_15).height($("#myCarousel").height()-55);app.getCensusData(_14,_12,_16);});},createGeoTree:function(_17){var _18={};$.each(_17,function(_19,_1a){var _1b,_1c,_1d,_1e,_1f;_1b=_1a.attributes;_1c=_1a.attributes.STATE;_1d=_1a.attributes.COUNTY;_1e=_1a.attributes.TRACT;_1f=_1a.attributes.BLKGRP;if(!_18.hasOwnProperty(_1c)){_18[_1c]={};}if(!_18[_1c].hasOwnProperty(_1d)){_18[_1c][_1d]={};}if(!_18[_1c][_1d].hasOwnProperty(_1e)){_18[_1c][_1d][_1e]=[];}if(_18[_1c][_1d][_1e].indexOf(_1f)<0){_18[_1c][_1d][_1e].push(_1f);}});return _18;},getCensusData:function(_20,_21,_22){require(["dojo/promise/all","esri/request","dojo/_base/array"],function(all,_23,_24){app.logResult("Requesting data for chart "+_22);var _25,_26,_27,_28;_27=config[_20.dataURL];_25=_20.data;_26=[];_28=[];_24.forEach(_25,function(_29){if(typeof _29.field==="string"){_26.push(_29.field);}else{_26.push.apply(_26,_29.field);}});$.each(_21,function(_2a,_2b){$.each(_2b,function(_2c,_2d){var _2e,_2f,_30;_30=_23({url:_27,content:{"key":config.censusKey,"get":_26.join(","),"for":"block group:*","in":"state:"+_2a+"+county:"+_2c},handleAs:"json"});_28.push(_30);});});all(_28).then(function(_31){var _32;_32=app.cleanResults(_31,_21);charting.createChart(_20,_32,_22);app._chartsDone=app._chartsDone+1;if(app._chartsDone===config.charts.length){$("#splashscreen").addClass("fade");$(".carousel-control").css("visibility","visible");}});});},cleanResults:function(_33,_34){var _35,_36;_35={};$.each(_34,function(_37,_38){$.each(_38,function(_39,_3a){$.each(_3a,function(_3b,_3c){$.each(_3c,function(_3d,bg){_36=_37+_39+_3b+String(bg);if(!_35.hasOwnProperty(_36)){_35[_36]={};}});});});});$.each(_33,function(_3e,_3f){var _40,_41,_42,_43,h,r,c;_40=_3f[0];_41={};for(h=0;h<_40.length;h++){_43=_40[h];if(!_41.hasOwnProperty(_43)){_41[_43]=[];}}for(r=1;r<_3f.length;r++){_42=_3f[r];for(c=0;c<_42.length;c++){_41[_40[c]].push(_42[c]);}}$.each(_41["block group"],function(_44,bg){var _45,_46;_46=_41.state[_44]+_41.county[_44]+_41.tract[_44]+String(bg);if(_35.hasOwnProperty(_46)){for(_45 in _40){_43=_40[_45];if(_43!=="state"&&_43!=="county"&&_43!=="tract"&&_43!=="block group"){_35[_46][_43]=_41[_43][_44];}}}});});return _35;},createMap:function(_47){require(["esri/map","dojo/domReady!"],function(Map){var _48,_49,_4a;_48={title:"Stand in the place that you are",description:""};_49=0;_4a="itemContent"+_49;$(app.itemTemplate(_48,_49)).appendTo(app._carsl).height($("#myCarousel").height());$("#"+_4a).height($("#myCarousel").height()-55);$("#item"+_49).addClass("active");app.map=new Map(_4a,{basemap:"gray",center:app._point});});},placeGraphics:function(){require(["esri/graphic","esri/symbols/PictureMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleLineSymbol","dojo/_base/Color"],function(_4b,PMS,SFS,SLS,_4c){var _4d,_4e;if(app.map){if(app.map.graphics){app.map.graphics.clear();}_4d=new _4b(app._point,new PMS({"url":"img/here.png","height":19,"width":16,"type":"esriPMS"}));_4e=new _4b(app._buffer,new SFS(SFS.STYLE_NULL,new SLS(SLS.STYLE_SOLID,new _4c([255,255,0]),2),new _4c([255,255,0])));app.map.graphics.add(_4d);app.map.graphics.add(_4e);app.map.setExtent(app._buffer.getExtent().expand(1.2),true);}});},logResult:function(_4f){$("<div></div>").addClass("alert-info").addClass("alert-info").html(_4f).appendTo(app._alertBox);console.log(_4f);},itemTemplate:function(_50,num){var _51="<div id=\"item"+num+"\" class=\"item active\">";_51+="<div id=\"itemContent"+num+"\" class=\"itemContent\"></div>";_51+="<div class=\"carousel-caption\"><h4>"+_50.title+"</h4><p>"+_50.description+"</p></div>";_51+="</div>";return _51;}};charting={createChart:function(_52,_53,_54){switch(_52.type){case "pie":charting.createPieChart(_52,_53,_54);break;case "treemap":charting.createTreeMap(_52,_53,_54);break;case "pyramid":charting.createPyramidChart(_52,_53,_54);break;case "stackedBar":charting.createStackedBars(_52,_53,_54);break;default:break;}app.logResult("Created Chart #"+_54);},createStackedBars:function(_55,_56,_57){var _58,_59,_5a,_5b,_5c,_5d,_5e,_5f,_60;_58="itemContent"+_57;_59=[];_5a=chartUtils.getOperation(_55.statistic);_5b=_5a(_55,_56);_5c=[];_5d=[];_5e=[];_5f={};$.each(_5b,function(_61,_62){if(_5c.indexOf(_62.category)<0){_5c.push(_62.category);}if(_5e.indexOf(_62.label)<0){_5e.push(_62.label);}if(!_5f.hasOwnProperty(_62.label)){_5f[_62.label]=[];}_5f[_62.label].push(_62.value);});$.each(_5e,function(_63,_64){_5d.push(_5f[_64]);_5e[_63]={"label":_64};});$("#"+_58).append("<div id=\""+_58+"_inner\" class=\"innerBox\" ></div>");_60=$.jqplot(_58+"_inner",_5d,{seriesColors:_55.colors,stackSeries:true,seriesDefaults:{renderer:$.jqplot.BarRenderer,rendererOptions:{barMargin:30,highlightMouseDown:true},pointLabels:{show:true}},series:_5e,axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:_5c},yaxis:{padMin:0}},legend:{show:true,location:"s",placement:"outsideGrid"}});$("window").on("resize",function(_65){_60.redraw();});if(_57!==0){$("#item"+_57).removeClass("active");}},createPieChart:function(_66,_67,_68){var _69,_6a,_6b,_6c,_6d;_69="itemContent"+_68;_6a=[];_6b=chartUtils.getOperation(_66.statistic);_6c=_6b(_66,_67);$.each(_6c,function(_6e,_6f){_6a.push([_6f.label,_6f.value]);});$("#"+_69).append("<div id=\""+_69+"_inner\" class=\"innerBox\" ></div>");_6d=$.jqplot(_69+"_inner",[_6a],{seriesDefaults:{renderer:$.jqplot.PieRenderer,rendererOptions:{showDataLabels:true}},legend:{show:true,location:"e",placement:"outsideGrid"}});$(window).resize(function(_70){_6d.redraw();});if(_68!==0){$("#item"+_68).removeClass("active");}},createTreeMap:function(_71,_72,_73){var _74,_75,_76,_77,_78,_79,_7a,_7b,_7c,div;_74="itemContent"+_73;_75=chartUtils.getOperation(_71.statistic);_76=_75(_71,_72);_77={name:_71.title,children:[]};_78={};$.each(_76,function(_7d,_7e){if(!_78.hasOwnProperty(_7e.category)){_78[_7e.category]={name:_7e.category,children:[]};}_78[_7e.category].children.push({name:_7e.label,value:_7e.value});});$.each(_78,function(key,_7f){_77.children.push(_7f);});_79=$("#"+_74).innerWidth();_7a=$("#"+_74).innerHeight();_7b=d3.scale.category20c();_7c=d3.layout.treemap().size([_79,0.85*_7a]).round(true).value(function(d){return d.value;});div=d3.select("#"+_74).append("div").style("position","relative").style("width",_79+"px").style("height","85%");div.data([_77]).selectAll("div").data(_7c.nodes).enter().append("div").attr("class","cell");div.style("background",function(d){return d.children?_7b(d.name):null;}).call(cell).text(function(d){return d.children?null:d.name+" ("+d.value+")";});if(_73!==0){$("#item"+_73).removeClass("active");}},createPyramidChart:function(_80,_81,_82){var _83,_84,_85,_86,_87,_88,_89,_8a,_8b,_8c,_8d;_83="itemContent"+_82;_84=[];_85=chartUtils.getOperation(_80.statistic);_86=_85(_80,_81);_87={};_88=[];_89=[];_8a=[];_8b=[];$.each(_86,function(_8e,_8f){if(_88.indexOf(_8f.category)<0){_88.push(_8f.category);}if(!_87.hasOwnProperty(_8f.label)){_87[_8f.label]={};}_87[_8f.label][_8f.category]=_8f.value;});$.each(_87,function(key,_90){_89.push(key);_8a.push(_90[_88[0]]);_8b.push(_90[_88[1]]);});_8c={title:"<div style=\"float:left;width:50%;text-align:center\">"+_88[0]+"</div><div style=\"float:right;width:50%;text-align:center\">"+_88[1]+"</div>",seriesColors:_80.colors,grid:{},defaultAxisStart:0,seriesDefaults:{renderer:$.jqplot.PyramidRenderer,rendererOptions:{barPadding:0},yaxis:"yaxis",shadow:false},series:[{rendererOptions:{side:"left",synchronizeHighlight:1},yaxis:"yMidAxis",xaxis:"xaxis"},{rendererOptions:{synchronizeHighlight:0},xaxis:"xaxis",yaxis:"yMidAxis"}],axes:{xaxis:{tickOptions:{},rendererOptions:{baselineWidth:2}},yMidAxis:{label:"Age",tickOptions:{},showMinorTicks:true,ticks:_89,rendererOptions:{category:true,baselineWidth:2}}}};$("#"+_83).append("<div id=\""+_83+"_inner\" class=\"innerBox\" ></div>");_8d=$.jqplot(_83+"_inner",[_8a,_8b],_8c);$("window").on("resize",function(_91){_8d.redraw();});if(_82!==0){$("#item"+_82).removeClass("active");}}};chartUtils={getOperation:function(_92){var _93;switch(_92){case "sum":_93=chartUtils.sumColumn;break;case "sumCat":_93=chartUtils.sumCategory;break;case "average":_93=chartUtils.avgColumn;break;default:break;}return _93;},sumColumn:function(_94,_95){var _96;_96=[];$.each(_94.data,function(_97,_98){var _99,_9a;_99=_98.field;if(typeof _99==="string"){_99=[_99];}_9a=0;$.each(_99,function(_9b,_9c){$.each(_95,function(key,obj){_9a+=parseFloat(_95[key][_9c]);});});_98.value=_9a;_96.push(_98);});return _96;},sumCategory:function(_9d,_9e){var _9f,_a0;_9f=[];_a0={};$.each(_9d.data,function(_a1,_a2){var _a3,_a4;_a3=_a2.field;_a4=_a2.category;if(!_a0.hasOwnProperty(_a4)){_a0[_a4]={label:_a4,value:0};}$.each(_9e,function(key,obj){_a0[_a4].value+=parseFloat(_9e[key][_a3]);});});$.each(_a0,function(key,obj){_9f.push(_a0[key]);});return _9f;},avgColumn:function(_a5,_a6){var _a7,sum;_a7=[];sum=chartUtils.sumColumn(_a5,_a6);$.each(sum,function(_a8,_a9){_a9.value=_a9.value/_a6.length;_a7.push(_a9);});return sum/_a6.length;}};UNITS={"meters":9001,"feet":9002,"kilometers":9036,"miles":9035};cell=function(){this.style("left",function(d){return d.x+"px";}).style("top",function(d){return d.y+"px";}).style("width",function(d){return Math.max(0,d.dx-1)+"px";}).style("height",function(d){return Math.max(0,d.dy-1)+"px";});};